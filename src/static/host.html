<html>
  <head>
    <title>A Multiplayer Game</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      canvas {
        box-sizing: border-box;
        width: 100%;
        height: 100vh;
        border: 5px solid black;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
  </body>
  <script>
    var socket = io();

    var canvas = document.getElementById("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    var ctx=canvas.getContext("2d");

    var player = {
      x: 100.0,
      y: 100.0,
      v: 0,
      vx: 0.0,
      vy: 0.0,
      dir: 90
    }

    var friction = 0.98;
    var turnRate = 0.4;
    var maxV = 10;

    drawPlayer();

    function handleUpdate(control) {
      updatePlayer(control);
      drawPlayer();
    }

    function updatePlayer(control={v:0, d:0}) {
      player.v = (player.v + control.v) * 0.6;
      player.dir = (player.dir - control.d * Math.abs(control.v) * turnRate);

      player.vx = (Math.sin(player.dir) + player.vx) * 2 * player.v * friction;
      player.vy = (Math.cos(player.dir) + player.vy) * 2 * player.v * friction;
      
      player.x = updateX(player.x, player.vx);
      player.y = updateY(player.y, player.vy);
      //console.log(player)
    }

    function updateX(pos, vel) {
      if (pos + vel < 0) return 0;
      if (pos + vel + 20 > canvas.width) return canvas.width - 20;
      return pos + vel;
    }

    function updateY(pos, vel) {
      if (pos + vel < 0) return 0;
      if (pos + vel + 20 > canvas.height) return canvas.height - 20;
      return pos + vel;
    }

    function drawPlayer(playerId) {
      ctx.beginPath();
      ctx.clearRect(0,0,canvas.width, canvas.height);
      ctx.arc(player.x, player.y, 20, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.moveTo(player.x, player.y);
      ctx.lineTo(player.x + Math.sin(player.dir) * 20, player.y + Math.cos(player.dir) * 20);
      ctx.stroke();
      ctx.closePath();
    }

    socket.on('control_event', updatePlayer);

    setInterval(handleUpdate, 16);
  </script>
</html>