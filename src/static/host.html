<html>
  <head>
    <title>A Multiplayer Game</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      canvas {
        box-sizing: border-box;
        width: 100%;
        height: 100vh;
        border: 5px solid black;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/vector2d.js"></script>
  </head>
  <body>
    <canvas id="game"></canvas>
  </body>
  <script>
    var socket = io();

    var canvas = document.getElementById("game");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    var ctx=canvas.getContext("2d");

    var players = {}

    var ball = {
      pos: new Vec2(300, 300),
      z: 0.0,
      vel: new Vec2(0, 0),
      vz: 0.0,
      az: 0.0
    }

    const friction = 0.98;
    const turnRate = 0.2;
    const maxV = 0.9;
    const physicsTicksPerFrame = 2;
    const simulationSpeed = 1.0;

    const playerSize = 20;
    const ballSize = 30;
    const borderPadding = 20;

    function handleUpdate() {
      t = performance.now();

      for (let i=0;i<physicsTicksPerFrame;i++) {
          dt = simulationSpeed / physicsTicksPerFrame;
          updatePlayerPositions(dt);
          updateBallPosition(dt);
      }

      ctx.clearRect(0,0,canvas.width, canvas.height);

      drawPlayers();
      drawBall();
      drawPerf(performance.now() - t)
      window.requestAnimationFrame(handleUpdate)
    }

    function forEachPlayer(callBack) {
      var keys = Object.keys(players);
      for (i = 0; i < keys.length; i++) {
        callBack(players[keys[i]]);
      }
    }

    function updatePlayerPositions(dt) {
      forEachPlayer(function(player){
        player.vel.x = (Math.cos(player.dir) + player.vel.x) * player.v;
        player.vel.y = (Math.sin(player.dir) + player.vel.y) * player.v;
        player.pos = updatePos(player.pos, Vec2.multiply(player.vel, dt));
      });
    }

    function updatePlayerData(control_event) {
      if (!players[control_event.id]) {
        console.log("Player " + control_event.id + " joined.");
        players[control_event.id] = {
          pos: new Vec2(100, 100),
          v: 0,
          vel: new Vec2(0, 0), 
          dir: 0
        }
      }
      var player = players[control_event.id];
      player.v = updateV(player.v, Math.max(0.0, Math.min(1.0, control_event.v)));

      // TODO store target dir but update the smoothed direction later
      player.dir = control_event.d;
    }

    function updateV(v, control_v) {
      if (control_v === 0) return v * 0.99;
      var new_v = control_v;

      if (new_v < -maxV) return -maxV;
      if (new_v > maxV) return maxV;

      return new_v;
    }

    function updatePos(pos, vel) {
      newpos = Vec2.add(pos, vel);
      newpos.x = Math.max(borderPadding, newpos.x);
      newpos.y = Math.max(borderPadding, newpos.y);
      newpos.x = Math.min(canvas.width - borderPadding, newpos.x);
      newpos.y = Math.min(canvas.height - borderPadding, newpos.y);
      return newpos;
    }

    function drawPlayers() {
      forEachPlayer(function(player){
	      ctx.beginPath();
	      ctx.arc(player.pos.x, player.pos.y, playerSize, 0, 2 * Math.PI);
	      ctx.stroke();
	      ctx.moveTo(player.pos.x, player.pos.y);
	      ctx.lineTo(player.pos.x + Math.cos(player.dir) * playerSize, player.pos.y + Math.sin(player.dir) * playerSize);
	      ctx.stroke();
	      ctx.closePath();
      });
    }

    function updateBallPosition(dt) {
      forEachPlayer(function(player){
        var delta = Vec2.subtract(ball.pos, player.pos);

        var distance = delta.magnitude();
        if (distance <= 50 && ball.z < 2) {
          var direction = Math.atan2(delta.x, delta.y);
          ball.vel.x = (Math.sin(direction) + 0.5*player.vel.x) * player.v * 4;
          ball.vel.y = (Math.cos(direction) + 0.5*player.vel.x) * player.v * 4;
          ball.vz = 5 * player.v + 2;
          player.pos = Vec2.subtract(player.pos, Vec2.multiply(delta, 0.1));
          player.v = player.v * 0.2;
        }
      })
      ball.vel = Vec2.multiply(ball.vel, 0.99);
      ball.vz = Math.max(ball.vz - 0.1, -5);
      ball.pos = updatePos(ball.pos, ball.vel);
      ball.z = Math.max(ball.z + dt * ball.vz, 0);
      if (ball.pos.x === canvas.width - borderPadding || ball.pos.x === borderPadding) ball.vel.x = -ball.vel.x;
      if (ball.pos.y === canvas.height - borderPadding || ball.pos.y === borderPadding) ball.vel.y = -ball.vel.y;
      if (ball.z <= 0) ball.vz = -ball.vz * 0.6;
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.pos.x, ball.pos.y, ballSize + ball.z, 0, 2 * Math.PI);
      ctx.fillStyle = "#c2c2c2";
      ctx.fill();
      ctx.stroke();
      ctx.closePath();
    }

    function drawPerf(time) {
      ctx.font = "12px";
      ctx.fillText(time.toFixed(2) + 'ms', 2, 10);
    }

    socket.on('control_event', updatePlayerData);

    window.requestAnimationFrame(handleUpdate);
  </script>
</html>
