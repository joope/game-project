<html>
  <head>
    <title>A Multiplayer Game</title>
    <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: black;
      }
      canvas {
        visibility: hidden;
        box-sizing: border-box;
        width: 100%;
        position: fixed;
        bottom: 12vh;
      }
      #config {
        width: 100%;
        height: 100vh;
        z-index: 10;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 8px 0 0 0;
      }
      button {
        display: block;
        width: 50vw;
        margin: 24px auto;
        border: none;
        background-color: yellowgreen;
        font-size: 18px;
        padding: 12px;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <form id="config">
      <input id="server" type="text" placeholder="Server ID" maxlength="4"/> <br>
      <input id="name" type="text" placeholder="Player name" maxlength="10"/> <br>
      <input id="emoji" type="text" placeholder="<emoji>" maxlength="1"/> <br>
      <button type="submit">Send</button>
    </form>
    <canvas id="touchArea"></canvas>
  </body>
  <script>
    var socket = io();

    var touchArea = document.getElementById("touchArea");
    var ctx = touchArea.getContext("2d");
    var audio = {}
    audio["vuvuzela"] = new Audio('/vuvuzela_long.mp3');

    touchArea.width = window.innerWidth;
    touchArea.height = window.innerWidth;

    var w_center = touchArea.width / 2;
    var y_center = touchArea.height / 2;

    var velocity = 0;
    var direction = 0;

    var controlInterval, serverId, name, emoji;

    document.getElementById("config").addEventListener("submit", setPlayerInfo,false);
    var serverInput = document.getElementById("server");
    var nameInput = document.getElementById("name");
    var emojiInput = document.getElementById("emoji");

    serverInput.value = window.localStorage.getItem('serverId') || 'AAAA';
    nameInput.value = window.localStorage.getItem('playerName') || '';
    emojiInput.value = '';

    if (serverInput.value === 'AAAA' && nameInput.value && emojiInput.value) {
      setPlayerInfo(document.createEvent('event'))
    }

    function setPlayerInfo(event) {
      event.preventDefault();
      serverId = serverInput.value;
      name = nameInput.value;
      emoji = emojiInput.value;

      window.localStorage.setItem('serverId', serverId)
      window.localStorage.setItem('playerName', name)
      window.localStorage.setItem('playerEmoji', emoji)

      // TODO check values
      socket.emit('register', {serverId: serverId, name: name, emoji: emoji});
      document.getElementById("config").style.visibility = "hidden";
      document.getElementById("touchArea").style.visibility = "visible";
    }
    /* 
    var serverId = window.localStorage.getItem('serverId') || 'AAAA';
    var playerName = window.localStorage.getItem('playerName') || window.prompt('Name enter');
    //window.localStorage.setItem('serverId', serverId);
    if (!playerName) playerName = 'Anonyymi';
    socket.emit('register', {serverId: serverId, name: playerName});
    window.localStorage.setItem('playerName', playerName);
    */

    function reconnect(){
      console.log('reconnect')
      window.setTimeout(function(){
        socket.emit('register', {serverId: serverId, name: name, emoji: emoji});
      }, 1000)
    }

    console.log(touchArea.width, touchArea.height);

    ctx.fillStyle = 'rgb(70, 70, 70)';
    ctx.fillRect(0, 0, touchArea.width, touchArea.height);

    function sendControl() {
      socket.emit('control', {v: velocity, d: direction});
    }

    function handlePosition(event) {

      var surfaceSize = w_center - 32;

      var touchX = touchArea.width / 2;
      var touchY = touchArea.height / 2;

      if (event && event.touches) {
        event.preventDefault();
        touchX = event.touches[0].pageX - touchArea.offsetLeft;
        touchY = event.touches[0].pageY - touchArea.offsetTop;
      }

      var cx = touchArea.width / 2;
      var cy = touchArea.height / 2;

      // Both coordinates are divided by the same length to keep the aspect ratio
      // of the control surface square.
      var x = (touchX - w_center) / surfaceSize;
      var y = (touchY - y_center) / surfaceSize;

      if (event) {
        direction = Math.atan2(y, x);     // angle between screen center and touch position
        velocity = Math.sqrt(x*x + y*y) * 1.5;  // distance from center, needs to be clamped on the server
      }

      ctx.fillStyle = 'rgb(70, 70, 70)';
      ctx.fillRect(0, 0, touchArea.width, touchArea.height);

      var size = cx/2;

      ctx.beginPath();
      ctx.save();
      ctx.strokeStyle = 'grey';
      ctx.fillStyle = 'grey';
      ctx.lineWidth = 4;
      ctx.arc(cx, cy, size, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.restore();
      ctx.closePath();

      ctx.beginPath();
      ctx.save();
      ctx.fillStyle = 'black';
      ctx.lineWidth = 4;
      ctx.arc(touchX, touchY, size, 0, 2 * Math.PI);
      ctx.fillStyle = 'red';
      ctx.fill();
      ctx.stroke();
      ctx.restore();
      ctx.closePath();

      // console.log("x", x, "y", y, "dir", direction, "angles", direction * 180 / Math.PI, "vel", velocity);

    }

    touchArea.addEventListener("touchstart", handlePosition, false);
    touchArea.addEventListener("touchmove", handlePosition, false);

    touchArea.addEventListener("touchend", function(){
      velocity = 0;
      handlePosition(null, true);
    }, false);

    document.addEventListener('keydown', function(event){
      switch (event.key)
      {
        case "ArrowUp":
          velocity = 1;
          break;
        case "ArrowDown":
          velocity = -1;
          break;
        case "ArrowLeft":
          direction = direction - 0.5;
          break;
        case "ArrowRight":
          direction = direction + 0.5;
          break;
      }
    });

    function playSound(sound_event) {
      console.log("playsound", sound_event, audio);
      // audio[sound_event["sound"]].play()
    }

    function vibrate(){
      console.log('crash');
      window.navigator.vibrate(200);
    }

    setInterval(sendControl, 30);

    socket.on('playsound', playSound);
    socket.on('crash', vibrate);
    socket.on('disconnect', reconnect);

  </script>
</html>
