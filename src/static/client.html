<html>
  <head>
    <title>A Multiplayer Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        margin: 10vh 0 0 0;
        padding: 0;
      }
      canvas {
        box-sizing: border-box;
        border: 5px solid black;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <canvas id="touchArea"></canvas>
  </body>
  <script>
    var socket = io();

    var touchArea = document.getElementById("touchArea");
    var ctx = touchArea.getContext("2d");

    touchArea.width = window.innerWidth;
    touchArea.height = window.innerWidth;

    var w_center = touchArea.width / 2;
    var y_center = touchArea.height / 2;

    var velocity = 0;
    var direction = 0;

    var controlInterval;

    console.log(touchArea.width, touchArea.height);

    function sendControl() {
      socket.emit('control', {v: velocity, d: direction});
    }

    function handlePosition(event) {
      event.preventDefault();

      var surfaceSize = w_center - 32;

      var touchX = event.touches[0].pageX - touchArea.offsetLeft;
      var touchY = event.touches[0].pageY - touchArea.offsetTop;
      var cx = touchArea.width / 2;
      var cy = touchArea.height / 2;

      // Both coordinates are divided by the same length to keep the aspect ratio
      // of the control surface square.
      var x = (touchX - w_center) / surfaceSize;
      var y = (touchY - y_center) / surfaceSize;

      direction = Math.atan2(y, x);     // angle between screen center and touch position
      velocity = Math.sqrt(x*x + y*y);  // distance from center, needs to be clamped on the server

      ctx.fillStyle = 'rgb(70, 70, 70)'
      ctx.clearRect(0, 0, touchArea.width, touchArea.height);

      var size = cx/2;

      ctx.beginPath();
      ctx.save();
      ctx.strokeStyle = 'grey';
      ctx.fillStyle = 'grey';
      ctx.lineWidth = 4;
      ctx.arc(cx, cy, size, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.restore();
      ctx.closePath();

      ctx.beginPath();
      ctx.save();
      ctx.fillStyle = 'black';
      ctx.lineWidth = 4;
      ctx.arc(touchX, touchY, size, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.restore();
      ctx.closePath();

      // console.log("x", x, "y", y, "dir", direction, "angles", direction * 180 / Math.PI, "vel", velocity);

    }

    touchArea.addEventListener("touchstart", handlePosition, false);
    touchArea.addEventListener("touchmove", handlePosition, false);

    touchArea.addEventListener("touchend", function(){
      velocity = 0;
    }, false);

    document.addEventListener('keydown', function(event){
      switch (event.key)
      {
        case "ArrowUp":
          velocity = 1;
          break;
        case "ArrowDown":
          velocity = -1;
          break;
        case "ArrowLeft":
          direction = direction - 0.5;
          break;
        case "ArrowRight":
          direction = direction + 0.5;
          break;
      }
    });
	
    setInterval(sendControl, 30);

  </script>
</html>
